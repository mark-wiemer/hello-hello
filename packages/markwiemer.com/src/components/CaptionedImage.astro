---
/**
 * A custom image component that displays an image with an optional caption.
 * Handles aspect ratio based on image metadata.
 *
 * Usage:
 * - String caption: <CaptionedImage src={img} alt="..." caption="Text" />
 * - Component caption: <CaptionedImage src={img} alt="..."><a href="#">Link</a></CaptionedImage>
 */

import { Image } from "astro:assets";
import type { ComponentProps } from "astro/types";

interface Props {
  alt: string;
  src: any; // ImageMetadata
  caption?: string;
  /** defaults to false */
  eager?: boolean;
  /** number between 0 and 1 */
  widthFraction?: number;
  border?: boolean;
}

const { src, alt, caption, eager, widthFraction, border } = Astro.props;

// Extract width and height from the image metadata
const trueWidthFraction =
  widthFraction && widthFraction > 0 && widthFraction <= 1 ? widthFraction : 1;
const aspectRatio = src.width / src.height;
let klass = border ? "border" : ""; // keep this here in case of future styles

const imageProps: ComponentProps<typeof Image> = {
  src,
  alt,
  width: src.width,
  height: src.height,
  loading: eager ? "eager" : "lazy",
  class: klass,
  style: `
    aspect-ratio: ${aspectRatio};
    width: ${trueWidthFraction * 100}%;
    height: auto;
  `,
};
---

{
  caption || Astro.slots.has("default") ? (
    <figure class={trueWidthFraction !== 1 ? "center" : ""}>
      <Image {...imageProps} />
      <figcaption>
        {caption ? <span>{caption}</span> : null}
        {Astro.slots.has("default") ? <slot /> : null}
      </figcaption>
    </figure>
  ) : (
    <Image {...imageProps} />
  )
}
